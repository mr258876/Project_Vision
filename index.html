<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0">

    <title>神之眼实用程序</title>
    <link rel="stylesheet" href="./css/mdui.min.css" />
    <script src="./js/jquery-3.6.3.min.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.js"></script>
</head>

<body
    class="mdui-appbar-with-toolbar mdui-bottom-nav-fixed mdui-theme-primary-teal mdui-theme-accent-orange mdui-theme-layout-auto">
    <header class="mdui-appbar mdui-appbar-fixed" id="appbar">
        <div class="mdui-toolbar mdui-color-theme">
            <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons"></i></a>
            <a href="javascript:;" class="mdui-typo-title">神之眼实用程序</a>
            <div class="mdui-toolbar-spacer"></div>
            <a href="https://github.com/mr258876/Project_Vision_L" class="mdui-btn mdui-btn-icon"
                mdui-tooltip="{content: 'Github主页'}"><ion-icon class="mdui-icon" name="logo-github"></ion-icon></a>
        </div>
        <div class="mdui-progress" id="progress-bar" hidden>
            <div class="mdui-progress-indeterminate"></div>
        </div>
    </header>

    <br />

    <div class="mdui-container">
        <div class="mdui-typo" id="basic-info">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">设备信息</div>
            </div>
            <div class="mdui-row mdui-valign">
                <div class="mdui-col-xs-6 mdui-col-sm-4 mdui-col-md-2"><img id="device_img"></div>
                <div class="mdui-col-xs-6 mdui-col-sm-8 mdui-col-md-10">
                    <p>设备名称：<span id="device_name"></span></p>
                    <p>固件版本：<span id="device_app_version"></span></p>
                    <p>硬件版本：<span id="device_hw_version"></span></p>
                    <p>MAC地址：<span id="device_mac_address"></span></p>
                </div>
            </div>
        </div>

        <hr />

        <div id="device-settings">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">设备设置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item">
                        <h4>显示</h4>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="beightness-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons" id="brightness-icon">brightness_auto</i>
                        <label class="mdui-list-item-content mdui-slider mdui-slider-discrete">
                            <input type="range" step="1" min="1" max="100" id="brightness-slider" />
                        </label>
                        <label class="mdui-switch mdui-valign" id="brightness-auto-switch">
                            <input type="checkbox" id="brightness-auto-check" /><i class="mdui-switch-icon"></i>
                        </label>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="rotation-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons" id="rotation-icon">screen_rotation</i>
                        <div class="mdui-list-item-content">自动旋转</div>
                        <label class="mdui-switch mdui-valign">
                            <input type="checkbox" id="rotation-auto-check" /><i class="mdui-switch-icon"></i>
                        </label>
                    </li>
                    <li class="mdui-list-item">
                        <h4>区域和语言</h4>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="language-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons">language</i>
                        <div class="mdui-list-item-content">语言</div>
                        <select class="mdui-select" id="device-language-select">
                            <option value="0">English</option>
                            <option value="1">简体中文</option>
                        </select>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="timezone-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons">timelapse</i>
                        <div class="mdui-list-item-content">时区</div>
                        <select class="mdui-select" id="device-timezone-select">
                            <option value="UTC+12">(GMT -12:00) 埃尼威托克，夸贾林</option>
                            <option value="UTC+11">(GMT -11:00) 中途岛，萨摩亚</option>
                            <option value="UTC-+10">(GMT -10:00) 夏威夷</option>
                            <option value="UTC+9:30">(GMT -9:30) 太海</option>
                            <option value="UTC+9">(GMT -9:00) 阿拉斯加</option>
                            <option value="UTC+8">(GMT -8:00) 太平洋时间（美国和加拿大）</option>
                            <option value="UTC+7">(GMT -7:00) 山区时间（美国和加拿大）</option>
                            <option value="UTC+6">(GMT -6:00) 中部时间（美国和加拿大），墨西哥城</option>
                            <option value="UTC+5">(GMT -5:00) 东部时间（美国和加拿大），波哥大，利马</option>
                            <option value="UTC+4:30">(GMT -4:30) 加拉加斯</option>
                            <option value="UTC+4">(GMT -4:00) 大西洋时间（加拿大），加拉加斯，拉巴斯</option>
                            <option value="UTC+3:30">(GMT -3:30) 纽芬兰</option>
                            <option value="UTC+3">(GMT -3:00) 巴西、布宜诺斯艾利斯、乔治敦</option>
                            <option value="UTC+2">(GMT -2:00) 中大西洋</option>
                            <option value="UTC+1">(GMT -1:00) 亚速尔群岛，佛得角群岛</option>
                            <option value="UTC+0" selected>(GMT) 西欧时间、伦敦、里斯本、卡萨布兰卡</option>
                            <option value="UTC-1">(GMT +1:00) 布鲁塞尔、哥本哈根、马德里、巴黎</option>
                            <option value="UTC-2">(GMT +2:00) 南非加里宁格勒</option>
                            <option value="UTC-3">(GMT +3:00) 巴格达、利雅得、莫斯科、圣彼得堡</option>
                            <option value="UTC-3:30">(GMT +3:30) 德黑兰</option>
                            <option value="UTC-4">(GMT +4:00) 阿布扎比、马斯喀特、巴库、第比利斯</option>
                            <option value="UTC-4:30">(GMT +4:30) 喀布尔</option>
                            <option value="UTC-5">(GMT +5:00) 叶卡捷琳堡、伊斯兰堡、卡拉奇、塔什干</option>
                            <option value="UTC-5:30">(GMT +5:30) 孟买、加尔各答、马德拉斯、新德里</option>
                            <option value="UTC-5:45">(GMT +5:45) 博卡拉加德满都</option>
                            <option value="UTC-6">(GMT +6:00) 阿拉木图、达卡、科伦坡</option>
                            <option value="UTC-6:30">(GMT +6:30) 仰光，曼德勒</option>
                            <option value="UTC-7">(GMT +7:00) 曼谷、河内、雅加达</option>
                            <option value="UTC-8">(GMT +8:00) 北京、珀斯、新加坡、香港</option>
                            <option value="UTC-8:45">(GMT +8:45) 尤克拉</option>
                            <option value="UTC-9">(GMT +9:00) 东京、首尔、大阪、札幌、雅库茨克</option>
                            <option value="UTC-9:30">(GMT +9:30) 阿德莱德、达尔文</option>
                            <option value="UTC-10">(GMT +10:00) 澳大利亚东部、关岛、海参崴</option>
                            <option value="UTC-10:30">(GMT +10:30) 豪勋爵岛</option>
                            <option value="UTC-11">(GMT +11:00) 马加丹，所罗门群岛，新喀里多尼亚</option>
                            <option value="UTC-11:30">(GMT +11:30) 诺福克岛</option>
                            <option value="UTC-12">(GMT +12:00) 奥克兰、惠灵顿、斐济、堪察加</option>
                            <option value="UTC-12:45">(GMT +12:45) 查塔姆群岛</option>
                            <option value="UTC-13">(GMT +13:00) 阿皮亚，努库阿洛法</option>
                            <option value="UTC-14">(GMT +14:00) 莱恩群岛，托克劳</option>
                        </select>
                    </li>
                </ul>
            </div>
        </div>

        <hr />

        <div id="weather-config">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">天气配置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item mdui-ripple" style="overflow: visible;">
                        <i class="mdui-list-item-icon mdui-icon material-icons">location_on</i>
                        <div class="mdui-list-item-content">位置</div>
                        <div>
                            <div class="mdui-textfield mdui-valign">
                                <input class="mdui-textfield-input" type="text" placeholder="位置" autocomplete="off"
                                    id="device-weather-loc-input" />
                            </div>
                            <ul class="mdui-list mdui-color-white" id="city-select-ul"
                                style="position: absolute; z-index: 1; height: 205px;width: auto;overflow-y: scroll;float: left;clear: both;"
                                hidden>

                            </ul>
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">language</i>
                        <div class="mdui-list-item-content">天气源</div>
                        <select class="mdui-select" disabled>
                            <option value="0">Open-meteo</option>
                            <option value="1" selected>墨迹天气</option>
                        </select>
                    </li>
                </ul>
            </div>
        </div>

        <hr />

        <div id="hoyolab-config" hidden>
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">米游社配置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">account_circle</i>
                        <div class="mdui-list-item-content">UID</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" placeholder="UID" autocomplete="off" />
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">verified_user</i>
                        <div class="mdui-list-item-content">Cookie</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" rows="3" placeholder="Cookie" autocomplete="off">
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">android</i>
                        <div class="mdui-list-item-content">设备GUID</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" placeholder="UID" autocomplete="off" />
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content"></div>
                        <button class="mdui-btn mdui-color-theme-accent mdui-ripple">更新米游社配置</button>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <div class="mdui-bottom-nav mdui-bottom-nav-text-auto mdui-color-theme" style="z-index: 1;" hidden>
        <a href="javascript:;" class="mdui-ripple mdui-bottom-nav-active">
            <i class="mdui-icon material-icons">settings</i>
            <label>设备配置</label>
        </a>
        <a href="javascript:;" class="mdui-ripple">
            <i class="mdui-icon material-icons">playlist_play</i>
            <label>播放列表</label>
        </a>
        <a href="javascript:;" class="mdui-ripple">
            <i class="mdui-icon material-icons">folder_open</i>
            <label>文件管理</label>
        </a>
    </div>

    <div class="mdui-dialog" id="connect-fail-dialog">
        <div class="mdui-dialog-title">连接已断开</div>
        <div class="mdui-dialog-content">设备在规定的时间内没有响应。请检查设备网络状态，然后重试。</div>
        <div class="mdui-dialog-actions">
            <button class="mdui-btn mdui-ripple" mdui-dialog-confirm>重新连接</button>
        </div>
    </div>

    <script src="./js/mdui.min.js"></script>
</body>

<script>
    $.ajaxSettings.timeout = 5000;

    const API_PREFIX = "/api/v1";
    const DEVICE_IMG = ["", "./images/Liyue_Extended.png", "", "./images/Mondstadt.png"];

    var device_IP = "10.16.216.129";

    var device_name;
    var device_app_version;
    var device_hw_version;
    var device_mac_address;

    var device_brightness;
    var device_auto_bright;
    var device_auto_rotate;
    var device_language;
    var device_timezone;

    function hideProgressBar() {
        $("#progress-bar").prop("hidden", true);
    }
    function showProgressBar() {
        $("#progress-bar").prop("hidden", false);
    }

    function updateBrighenessIcon() {
        if (device_auto_bright) {
            $("#brightness-auto-check").prop("checked", true);
            $("#brightness-slider").prop("disabled", true);
            $("#brightness-icon").html("brightness_auto");
        } else {
            $("#brightness-auto-check").prop("checked", false);
            $("#brightness-slider").prop("disabled", false);
            $("#brightness-slider").val(Math.round(device_brightness / 255 * 100));
            if ($("#brightness-slider").val() < 33) {
                $("#brightness-icon").html("brightness_low");
            } else if ($("#brightness-slider").val() < 67) {
                $("#brightness-icon").html("brightness_medium");
            } else {
                $("#brightness-icon").html("brightness_high");
            }
        }
        mdui.updateSliders();
    }

    function updateRotationIcon() {
        if (device_auto_rotate) {
            $("#rotation-auto-check").prop("checked", true);
            $("#rotation-icon").html("screen_rotation");
        } else {
            $("#rotation-auto-check").prop("checked", false);
            $("#rotation-icon").html("screen_lock_rotation");
        }
    }

    function getBrightness(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/brightness" + (val ? ("?value=" + Math.round(val * 2.55)) : ""), function (data) {
            device_brightness = data.setting_screenBrightness;
        })
            .done(function () {
                updateBrighenessIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function getAutoBright(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/auto_bright" + (val == undefined ? "" : (val ? "?value=true" : "?value=false")), function (data) {
            device_auto_bright = data.setting_autoBright;
        })
            .done(function () {
                updateBrighenessIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function getAutoRotate(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/auto_rotate" + (val == undefined ? "" : (val ? "?value=true" : "?value=false")), function (data) {
            device_auto_rotate = data.setting_useAccel;
        })
            .done(function () {
                updateRotationIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function getLanguage(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/language" + (val ? ("?value=" + val) : ""), function (data) {
            device_language = data.curr_lang;
        })
            .done(function () {
                $("#device-language-select").val(device_language);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function getTimezone(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/timezone" + (val ? ("?value=" + val.replace("+", "%2B")) : ""), function (data) {
            device_timezone = data.setting_timeZone;
        })
            .done(function () {
                $("#device-timezone-select").val(device_timezone);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function getWeatherLocation(city, lat, lon) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/weather/city" + ((city && lat && lon) ? ("?city=" + city + "&latitude=" + lat + "&longitude=" + lon) : ""), function (data) {
            device_weatherCity = data.city;
            device_weatherLatitude = data.latitude;
            device_weatherLongitude = data.longitude;
        })
            .done(function () {
                $("#device-weather-loc-input").val(device_weatherCity);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function fitHWVersion() {
        if (device_hw_version != 1) {
            $("#brightness-auto-switch").attr("hidden", true);
            $("#rotation-li").attr("hidden", true);
        }
    }

    function getDeviceVals() {
        if (device_hw_version == 1) {
            getAutoBright();
            getAutoRotate();
        }
        getBrightness();
        getLanguage();
        getTimezone();
    }

    function getWeatherVals() {
        getWeatherLocation();
    }

    function connectDevice() {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/info", function (data) {
            device_name = data.device_name;
            device_app_version = data.app_version;
            device_hw_version = data.hw_version;
            device_mac_address = data.mac_address;
        })
            .done(function () {
                mdui.snackbar({
                    message: '已连接至：' + device_name,
                    position: 'top'
                });
                $("#device_img").prop("src", DEVICE_IMG[device_hw_version]);
                $("#device_name").html(device_name);
                $("#device_app_version").html(device_app_version);
                $("#device_hw_version").html(device_hw_version);
                $("#device_mac_address").html(device_mac_address);

                fitHWVersion();
                getDeviceVals();
                getWeatherVals();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                var diag = new mdui.Dialog("#connect-fail-dialog", { overlay: true, history: false, modal: true, closeOnEsc: false, closeOnCancel: true, closeOnConfirm: true, destroyOnClosed: true });
                diag.open();
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    //获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }

    ////////////////////
    // 按钮回调函数
    ////////////////////

    // 连接失败对话框
    $("#connect-fail-dialog").on("confirm.mdui.dialog", function () {
        connectDevice();
    });

    // 亮度滑块
    $("#brightness-slider").change(function () {
        getBrightness($("#brightness-slider").val());
        updateBrighenessIcon();
    });

    // 自动亮度开关
    $("#brightness-auto-check").change(function () {
        getAutoBright($("#brightness-auto-check").is(":checked"));
        updateBrighenessIcon();
    });

    // 自动旋转开关
    $("#rotation-auto-check").change(function () {
        getAutoRotate($("#rotation-auto-check").is(":checked"));
        updateEotationIcon();
    });

    // 时区
    $("#device-timezone-select").change(function () {
        getTimezone($("#device-timezone-select").val())
    });

    // 天气城市输入框
    $("#device-weather-loc-input").keyup(function (event) {
        last = event.timeStamp;
        setTimeout(() => {
            if (last - event.timeStamp == 0 && $("#device-weather-loc-input").val()) {
                showProgressBar();
                $.getJSON("https://geocoding-api.open-meteo.com/v1/search?language=zh&name=" + $("#device-weather-loc-input").val(), function (data) {
                    var cities = data.results;
                    if (cities.length && cities.length > 0) {
                        $("#city-select-ul").prop("hidden", false);
                        $("#city-select-ul").html("");
                        for (let index = 0; index < cities.length; index++) {
                            const e = cities[index];
                            $("#city-select-ul").append("<li class='mdui-list-item mdui-ripple'>" + e.name + "(" + e.admin1 + "," + e.admin2 + ")<span hidden>" + e.name + "," +e.latitude + "," + e.longitude + "</span></li>");
                        }
                        $("#city-select-ul > li").on("click", function (event) {
                            let loc = $(event.target).children("span").html().split(",");
                            getWeatherLocation(loc[0], loc[1], loc[2]);
                        });
                    }
                })
                    .fail(function () {
                        mdui.snackbar({
                            message: "拉取城市信息失败",
                            position: 'top'
                        });
                    })
                    .always(function () {
                        hideProgressBar();
                    });
            }
        }, 500);
    });

    $(document).click(function (event) {
        let tar = event.srcElement || event.target;
        if (event.target.id != "city-select-ul") {
            $("#city-select-ul").prop("hidden", true);
        }
    });

    $(document).ready(function () {
        device_IP = getUrlParam("ip");
        if (device_IP) {
            connectDevice();
        } else {
            mdui.prompt("设备IP地址", "请指定设备IP地址", function (value) { $(location).prop("href", $(location).prop("href") + "?ip=" + value); }, function (value) { }, { confirmText: "确认", cancelText: "取消", modal: true, closeOnConfirm: false, confirmOnEnter: true, maxlength: 15 });
        }
    });
</script>

</html>