<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=0">

    <title>神之眼实用程序</title>
    <link rel="icon" type="image/png" sizes="32x32" href="./favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./favicon-16x16.png">
    <link rel="stylesheet" href="./css/mdui.min.css" />
    <script src="./js/jquery-3.6.3.min.js"></script>
    <script src="./js/Sortable.min.js"></script>
    <script src="./js/jquery-sortable.js"></script>
    <script type="module" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule="" src="https://unpkg.com/ionicons@latest/dist/ionicons/ionicons.js"></script>
</head>

<body
    class="mdui-appbar-with-toolbar mdui-bottom-nav-fixed mdui-theme-primary-teal mdui-theme-accent-orange mdui-theme-layout-auto">
    <header class="mdui-appbar mdui-appbar-fixed" id="appbar">
        <div class="mdui-toolbar mdui-color-theme">
            <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#drawer'}"><i
                    class="mdui-icon material-icons">menu</i></a>
            <a href="javascript:;" class="mdui-typo-title">神之眼实用程序</a>
            <div class="mdui-toolbar-spacer"></div>
            <a href="https://github.com/mr258876/Project_Vision_L" class="mdui-btn mdui-btn-icon"
                mdui-tooltip="{content: 'Github主页'}"><ion-icon class="mdui-icon" name="logo-github"></ion-icon></a>
        </div>
        <div class="mdui-progress" id="progress-bar" hidden>
            <div class="mdui-progress-indeterminate"></div>
        </div>
    </header>

    <br />

    <div class="mdui-container" id="settings-container">
        <div class="mdui-typo" id="basic-info">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">设备信息</div>
            </div>
            <div class="mdui-row mdui-valign">
                <div class="mdui-col-xs-6 mdui-col-sm-4 mdui-col-md-2"><img id="device_img"></div>
                <div class="mdui-col-xs-6 mdui-col-sm-8 mdui-col-md-10">
                    <p>设备名称：<span id="device_name"></span></p>
                    <p>固件版本：<span id="device_app_version"></span></p>
                    <p>硬件版本：<span id="device_hw_version"></span></p>
                    <p>MAC地址：<span id="device_mac_address"></span></p>
                </div>
            </div>
        </div>

        <hr /><br />

        <div id="device-settings">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">设备设置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item">
                        <h4>显示</h4>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="beightness-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons" id="brightness-icon">brightness_auto</i>
                        <label class="mdui-list-item-content mdui-slider mdui-slider-discrete">
                            <input type="range" step="1" min="1" max="100" id="brightness-slider" />
                        </label>
                        <label class="mdui-switch mdui-valign" id="brightness-auto-switch">
                            <input type="checkbox" id="brightness-auto-check" /><i class="mdui-switch-icon"></i>
                        </label>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="rotation-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons" id="rotation-icon">screen_rotation</i>
                        <div class="mdui-list-item-content">自动旋转</div>
                        <label class="mdui-switch mdui-valign">
                            <input type="checkbox" id="rotation-auto-check" /><i class="mdui-switch-icon"></i>
                        </label>
                    </li>
                    <li class="mdui-list-item">
                        <h4>区域和语言</h4>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="language-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons">language</i>
                        <div class="mdui-list-item-content">语言</div>
                        <select class="mdui-select" id="device-language-select">
                            <option value="0">English</option>
                            <option value="1">简体中文</option>
                        </select>
                    </li>
                    <li class="mdui-list-item mdui-ripple" id="timezone-li">
                        <i class="mdui-list-item-icon mdui-icon material-icons">timelapse</i>
                        <div class="mdui-list-item-content">时区</div>
                        <select class="mdui-select" id="device-timezone-select">
                            <option value="UTC+12">(GMT -12:00) 埃尼威托克，夸贾林</option>
                            <option value="UTC+11">(GMT -11:00) 中途岛，萨摩亚</option>
                            <option value="UTC-+10">(GMT -10:00) 夏威夷</option>
                            <option value="UTC+9:30">(GMT -9:30) 太海</option>
                            <option value="UTC+9">(GMT -9:00) 阿拉斯加</option>
                            <option value="UTC+8">(GMT -8:00) 太平洋时间（美国和加拿大）</option>
                            <option value="UTC+7">(GMT -7:00) 山区时间（美国和加拿大）</option>
                            <option value="UTC+6">(GMT -6:00) 中部时间（美国和加拿大），墨西哥城</option>
                            <option value="UTC+5">(GMT -5:00) 东部时间（美国和加拿大），波哥大，利马</option>
                            <option value="UTC+4:30">(GMT -4:30) 加拉加斯</option>
                            <option value="UTC+4">(GMT -4:00) 大西洋时间（加拿大），加拉加斯，拉巴斯</option>
                            <option value="UTC+3:30">(GMT -3:30) 纽芬兰</option>
                            <option value="UTC+3">(GMT -3:00) 巴西、布宜诺斯艾利斯、乔治敦</option>
                            <option value="UTC+2">(GMT -2:00) 中大西洋</option>
                            <option value="UTC+1">(GMT -1:00) 亚速尔群岛，佛得角群岛</option>
                            <option value="UTC+0" selected>(GMT) 西欧时间、伦敦、里斯本、卡萨布兰卡</option>
                            <option value="UTC-1">(GMT +1:00) 布鲁塞尔、哥本哈根、马德里、巴黎</option>
                            <option value="UTC-2">(GMT +2:00) 南非加里宁格勒</option>
                            <option value="UTC-3">(GMT +3:00) 巴格达、利雅得、莫斯科、圣彼得堡</option>
                            <option value="UTC-3:30">(GMT +3:30) 德黑兰</option>
                            <option value="UTC-4">(GMT +4:00) 阿布扎比、马斯喀特、巴库、第比利斯</option>
                            <option value="UTC-4:30">(GMT +4:30) 喀布尔</option>
                            <option value="UTC-5">(GMT +5:00) 叶卡捷琳堡、伊斯兰堡、卡拉奇、塔什干</option>
                            <option value="UTC-5:30">(GMT +5:30) 孟买、加尔各答、马德拉斯、新德里</option>
                            <option value="UTC-5:45">(GMT +5:45) 博卡拉加德满都</option>
                            <option value="UTC-6">(GMT +6:00) 阿拉木图、达卡、科伦坡</option>
                            <option value="UTC-6:30">(GMT +6:30) 仰光，曼德勒</option>
                            <option value="UTC-7">(GMT +7:00) 曼谷、河内、雅加达</option>
                            <option value="UTC-8">(GMT +8:00) 北京、珀斯、新加坡、香港</option>
                            <option value="UTC-8:45">(GMT +8:45) 尤克拉</option>
                            <option value="UTC-9">(GMT +9:00) 东京、首尔、大阪、札幌、雅库茨克</option>
                            <option value="UTC-9:30">(GMT +9:30) 阿德莱德、达尔文</option>
                            <option value="UTC-10">(GMT +10:00) 澳大利亚东部、关岛、海参崴</option>
                            <option value="UTC-10:30">(GMT +10:30) 豪勋爵岛</option>
                            <option value="UTC-11">(GMT +11:00) 马加丹，所罗门群岛，新喀里多尼亚</option>
                            <option value="UTC-11:30">(GMT +11:30) 诺福克岛</option>
                            <option value="UTC-12">(GMT +12:00) 奥克兰、惠灵顿、斐济、堪察加</option>
                            <option value="UTC-12:45">(GMT +12:45) 查塔姆群岛</option>
                            <option value="UTC-13">(GMT +13:00) 阿皮亚，努库阿洛法</option>
                            <option value="UTC-14">(GMT +14:00) 莱恩群岛，托克劳</option>
                        </select>
                    </li>
                </ul>
            </div>
        </div>

        <hr /><br />

        <div id="weather-config">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">天气配置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">location_on</i>
                        <div class="mdui-list-item-content">城市名称</div>
                        <div>
                            <div class="mdui-textfield mdui-valign">
                                <input class="mdui-textfield-input" type="text" placeholder="城市名称" autocomplete="off"
                                    id="device-weather-loc-name-input" />
                            </div>
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons"></i>
                        <div class="mdui-list-item-content">纬度</div>
                        <div>
                            <div class="mdui-textfield mdui-valign">
                                <input class="mdui-textfield-input" type="text" placeholder="纬度" autocomplete="off"
                                    id="device-weather-loc-lat-input" />
                            </div>
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons"></i>
                        <div class="mdui-list-item-content">经度</div>
                        <div>
                            <div class="mdui-textfield mdui-valign">
                                <input class="mdui-textfield-input" type="text" placeholder="经度" autocomplete="off"
                                    id="device-weather-loc-lon-input" />
                            </div>
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">language</i>
                        <div class="mdui-list-item-content">天气源</div>
                        <select class="mdui-select" disabled>
                            <option value="0">Open-meteo</option>
                            <option value="1" selected>墨迹天气</option>
                        </select>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content"></div>
                        <button class="mdui-btn mdui-color-theme-accent mdui-ripple"
                            id="update-weather-conf-btn">更新天气配置</button>
                    </li>
                </ul>
            </div>
        </div>

        <hr /><br />

        <div id="hoyolab-config">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">米游社配置</div>
            </div>

            <div class="mdui-row">
                <ul class="mdui-col-xs-12 mdui-list">
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">account_circle</i>
                        <div class="mdui-list-item-content">UID</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" placeholder="UID" autocomplete="off"
                                id="hoyolab-uid-input" />
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">verified_user</i>
                        <div class="mdui-list-item-content">Cookie</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" placeholder="Cookie" autocomplete="off"
                                id="hoyolab-cookie-input" />
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <i class="mdui-list-item-icon mdui-icon material-icons">android</i>
                        <div class="mdui-list-item-content">设备GUID</div>
                        <div class="mdui-textfield">
                            <input class="mdui-textfield-input" type="text" placeholder="GUID" autocomplete="off"
                                id="hoyolab-guid-input" />
                        </div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content"><small
                                class="mdui-typo-caption-opacity">由于安全策略，神之眼中储存的米游社配置将不会展示在该界面中</small></div>
                    </li>
                    <li class="mdui-list-item mdui-ripple">
                        <div class="mdui-list-item-content"></div>
                        <button class="mdui-btn mdui-color-theme-accent mdui-ripple"
                            id="update-hoyolab-conf-btn">更新米游社配置</button>
                    </li>
                </ul>
            </div>
        </div>

    </div>

    <div class="mdui-container" id="playlist-container" hidden>
        <div class="mdui-typo">
            <div class="mdui-row">
                <div class="mdui-col-xs-12 mdui-typo-title">播放列表</div>
            </div>
            <div class="mdui-row">
                <p class="mdui-col-xs-12">播放列表中文件总数：<span id="playlist-size-span"></span></p>
            </div>
        </div>

        <hr />

        <p><small class="mdui-typo-caption-opacity">您可以拖动列表左边的<i
                    class="mdui-icon material-icons">drag_handle</i>对播放列表进行排序，点击播放列表对应项进行播放</small></p>

        <ul class="mdui-list" id="playlist-ul">
            <li class="mdui-list-item mdui-ripple" id="playlist-li-2">
                <i class="mdui-list-item-icon mdui-icon material-icons drag-handle">drag_handle</i>
                <div class="mdui-list-item-content">
                    <div class="mdui-list-item-title mdui-list-item-one-line"><span id="playlist-li-2-fn"></span><i
                            class="mdui-icon material-icons" id="playlist-li-2-play-icon" hidden>play_arrow</i></div>
                    <div class="mdui-list-item-text mdui-list-item-one-line"><span id="playlist-li-2-fp"></span></div>
                </div>
                <button class="mdui-list-item-icon mdui-btn mdui-btn-icon mdui-btn-ripple"><i
                        class="mdui-icon material-icons">content_copy</i></button>
                <button class="mdui-list-item-icon mdui-btn mdui-btn-icon mdui-color-theme-accent mdui-btn-ripple"><i
                        class="mdui-icon material-icons">delete</i></button>
            </li>
        </ul>
    </div>

    <div class="mdui-bottom-nav mdui-bottom-nav-text-auto mdui-color-theme" id="bottom-nav-div">
        <a href="javascript:;" class="mdui-ripple mdui-bottom-nav-active" id="settings-a">
            <i class="mdui-icon material-icons">settings</i>
            <label>设备配置</label>
        </a>
        <a href="javascript:;" class="mdui-ripple" id="playlist-a">
            <i class="mdui-icon material-icons">playlist_play</i>
            <label>播放列表</label>
        </a>
        <a href="javascript:;" class="mdui-ripple" id="file-a" hidden>
            <i class="mdui-icon material-icons">folder_open</i>
            <label>文件管理</label>
        </a>
    </div>

    <div class="mdui-drawer mdui-drawer-close" id="drawer">
        <ul class="mdui-list">
            <li class="mdui-list-item mdui-ripple">
                <i class="mdui-list-item-icon mdui-icon material-icons">info</i>
                <div class="mdui-list-item-content" id="utility-about-div">关于实用程序</div>
            </li>
        </ul>
    </div>

    <script src="./js/mdui.min.js"></script>
</body>

<script>
    $.ajaxSettings.timeout = 5000;

    const API_PREFIX = "/api/v1";
    const DEVICE_IMG = ["", "./images/Liyue_Extended.png", "./images/Liyue.png", "./images/Mondstadt.png"];

    var device_IP;
    const IP_ADDRESS_EXP = /^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;

    var device_name;
    var device_app_version;
    var device_hw_version;
    var device_mac_address;

    var device_brightness;
    var device_auto_bright;
    var device_auto_rotate;
    var device_language;
    var device_timezone;

    var device_weatherCity;
    var device_weatherLatitude;
    var device_weatherLongitude;

    var device_playlist;
    var device_playlist_current;
    const PLAYLIST_ID_EXP = RegExp("[0-9]+", "g");
    const PLAYLIST_LI_BOM = '<li class="mdui-list-item mdui-ripple" id="playlist-li-{0}"><i class="mdui-list-item-icon mdui-icon material-icons drag-handle">drag_handle</i><div class="mdui-list-item-content"><div class="mdui-list-item-title mdui-list-item-one-line"><span id="playlist-li-{0}-fn"></span><i class="mdui-icon material-icons" id="playlist-li-{0}-play-icon" hidden>play_arrow</i></div><div class="mdui-list-item-text mdui-list-item-one-line"><span id="playlist-li-{0}-fp"></span></div></div><i class="mdui-list-item-icon mdui-icon material-icons playlist-copy">content_copy</i><i class="mdui-list-item-icon mdui-icon material-icons playlist-delete">delete</i></li>'

    ////////////////////
    //  helper函数
    ////////////////////

    function hideProgressBar() {
        $("#progress-bar").prop("hidden", true);
    }
    function showProgressBar() {
        $("#progress-bar").prop("hidden", false);
    }

    String.prototype.format = String.prototype.f = function () {
        var s = this,
            i = arguments.length;

        while (i--) {
            s = s.replace(new RegExp('\\{' + i + '\\}', 'gm'), arguments[i]);
        }
        return s;
    };

    ////////////////////
    //  ajax函数
    ////////////////////
    /* 改变亮度图标 */
    function updateBrighenessIcon() {
        if (device_auto_bright) {
            $("#brightness-auto-check").prop("checked", true);
            $("#brightness-slider").prop("disabled", true);
            $("#brightness-icon").html("brightness_auto");
        } else {
            $("#brightness-auto-check").prop("checked", false);
            $("#brightness-slider").prop("disabled", false);
            $("#brightness-slider").val(Math.round(device_brightness / 255 * 100));
            if ($("#brightness-slider").val() < 33) {
                $("#brightness-icon").html("brightness_low");
            } else if ($("#brightness-slider").val() < 67) {
                $("#brightness-icon").html("brightness_medium");
            } else {
                $("#brightness-icon").html("brightness_high");
            }
        }
        mdui.updateSliders();
    }
    /* 改变旋转图标 */
    function updateRotationIcon() {
        if (device_auto_rotate) {
            $("#rotation-auto-check").prop("checked", true);
            $("#rotation-icon").html("screen_rotation");
        } else {
            $("#rotation-auto-check").prop("checked", false);
            $("#rotation-icon").html("screen_lock_rotation");
        }
    }
    /* 获取/设置亮度 */
    function getBrightness(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/brightness" + (val ? ("?value=" + Math.round(val * 2.55)) : ""), function (data) {
            device_brightness = data.setting_screenBrightness;
        })
            .done(function () {
                updateBrighenessIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取/设置自动亮度开关 */
    function getAutoBright(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/auto_bright" + (val == undefined ? "" : (val ? "?value=true" : "?value=false")), function (data) {
            device_auto_bright = data.setting_autoBright;
        })
            .done(function () {
                updateBrighenessIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取/设置自动旋转开关 */
    function getAutoRotate(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/auto_rotate" + (val == undefined ? "" : (val ? "?value=true" : "?value=false")), function (data) {
            device_auto_rotate = data.setting_useAccel;
        })
            .done(function () {
                updateRotationIcon();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取/设置语言 */
    function getLanguage(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/language" + (val ? ("?value=" + val) : ""), function (data) {
            device_language = data.curr_lang;
        })
            .done(function () {
                $("#device-language-select").val(device_language);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取/设置时区 */
    function getTimezone(val) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/setting/timezone" + (val ? ("?value=" + val.replace("+", "%2B")) : ""), function (data) {
            device_timezone = data.setting_timeZone;
        })
            .done(function () {
                $("#device-timezone-select").val(device_timezone);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取/设置天气位置 */
    function getWeatherLocation(city, lat, lon) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/weather/city" + ((city && lat && lon) ? ("?city=" + city + "&latitude=" + lat + "&longitude=" + lon) : ""), function (data) {
            device_weatherCity = data.city;
            device_weatherLatitude = data.latitude;
            device_weatherLongitude = data.longitude;
        })
            .done(function () {
                $("#device-weather-loc-name-input").val(device_weatherCity);
                $("#device-weather-loc-lat-input").val(device_weatherLatitude);
                $("#device-weather-loc-lon-input").val(device_weatherLongitude);
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 设置米游社配置 */
    function postHoyolabConf(uid, cookie, guid) {
        showProgressBar();
        $.ajax({ type: "POST", contentType: "application/json", url: ("http://" + device_IP + API_PREFIX + "/hoyolab/conf"), data: JSON.stringify({ "uid": uid, "cookie": cookie, "device_guid": guid }), dataType: "json" })
            .done(function () {
                mdui.snackbar({
                    message: '米游社配置已更新',
                    position: 'top'
                });
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 获取播放列表 */
    function getPlaylist() {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/playlist", function (data) {
            device_playlist = data.files;
        })
            .done(function () {
                displayPlaylist();
                getCurrentPlaying();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 设置播放列表 */
    function postPlaylist(playlist) {
        showProgressBar();
        $.ajax({ type: "POST", contentType: "application/json", url: ("http://" + device_IP + API_PREFIX + "/playlist"), data: JSON.stringify({ "files": device_playlist }), dataType: "json" })
            .done(function () {
                displayPlaylist();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }
    /* 展示播放列表 */
    function displayPlaylist() {
        $("#playlist-ul").children("li").children("li > div").off("click");

        $("#playlist-size-span").html(device_playlist.length);
        $("#playlist-ul").html("");

        for (let i = 0; i < device_playlist.length; i++) {
            $("#playlist-ul").append(PLAYLIST_LI_BOM.format(i));
            $("#playlist-li-{0}-fp".format(i)).html(device_playlist[i]);
            let splitList = device_playlist[i].split("/");
            $("#playlist-li-{0}-fn".format(i)).html(splitList[splitList.length - 1]);
        }

        if (device_playlist_current) {
            $("#playlist-ul").children("li").removeClass("mdui-list-item-active");
            $("#playlist-ul").children("li").children("div").children("div").children("div > i").prop("hidden", true);
            $("#playlist-li-{0}-play-icon".format(device_playlist_current)).prop("hidden", false);
            $("#playlist-li-{0}".format(device_playlist_current)).addClass("mdui-list-item-active");
        }

        $("#playlist-ul").children("li").children("li > div").click(function (evt) {
            getCurrentPlaying(PLAYLIST_ID_EXP.exec($(evt.target).parents("li").attr("id")));
            PLAYLIST_ID_EXP.lastIndex = 0;
        });
        $("#playlist-ul").children("li").children("li > i.playlist-copy").click(function (evt) {
            device_playlist.push(device_playlist[PLAYLIST_ID_EXP.exec($(evt.target).parents("li").attr("id"))]);
            PLAYLIST_ID_EXP.lastIndex = 0;
            postPlaylist(device_playlist);
        });
        $("#playlist-ul").children("li").children("li > i.playlist-delete").click(function (evt) {
            device_playlist.splice(PLAYLIST_ID_EXP.exec($(evt.target).parents("li").attr("id")), 1);
            PLAYLIST_ID_EXP.lastIndex = 0;
            postPlaylist(device_playlist);
        });

        mdui.mutation();

        // 创建拖拽排序列表
        $("#playlist-ul").sortable('destroy');
        $("#playlist-ul").sortable({
            handle: ".drag-handle",
            animation: 150,
            fallbackTolerance: 4,
            onEnd: function (evt) {
                let fp = device_playlist[evt.oldIndex];
                device_playlist.splice(evt.oldIndex, 1);
                device_playlist.splice(evt.newIndex, 0, fp);
                if (device_playlist_current == evt.oldIndex) {
                    device_playlist_current = evt.newIndex;
                }
                postPlaylist(device_playlist);
            },
        });
    }
    /* 获取正在播放文件编号 */
    function getCurrentPlaying(fileNo) {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/playlist/current" + (fileNo ? ("?value=" + fileNo) : ""), function (data) {
            device_playlist_current = data.currFileId;
        })
            .done(function () {
                $("#playlist-ul").children("li").removeClass("mdui-list-item-active");
                $("#playlist-ul").children("li").children("div").children("div").children("div > i").prop("hidden", true);
                $("#playlist-li-{0}-play-icon".format(device_playlist_current)).prop("hidden", false);
                $("#playlist-li-{0}".format(device_playlist_current)).addClass("mdui-list-item-active");
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    function fitHWVersion() {
        if (device_hw_version != 1) {
            $("#brightness-auto-switch").attr("hidden", true);
            $("#rotation-li").attr("hidden", true);
        }
    }

    function getDeviceVals() {
        if (device_hw_version == 1) {
            getAutoBright();
            getAutoRotate();
        }
        getBrightness();
        getLanguage();
        getTimezone();
    }

    function getWeatherVals() {
        getWeatherLocation();
    }

    function getPlaylistVals() {
        getPlaylist();
    }

    function connectDevice() {
        showProgressBar();
        $.getJSON("http://" + device_IP + API_PREFIX + "/info", function (data) {
            device_name = data.device_name;
            device_app_version = data.app_version;
            device_hw_version = data.hw_version;
            device_mac_address = data.mac_address;
        })
            .done(function () {
                mdui.snackbar({
                    message: '已连接至：' + device_name,
                    position: 'top'
                });
                $("#device_img").prop("src", DEVICE_IMG[device_hw_version]);
                $("#device_name").html(device_name);
                $("#device_app_version").html(device_app_version);
                $("#device_hw_version").html(device_hw_version);
                $("#device_mac_address").html(device_mac_address);

                fitHWVersion();
                getDeviceVals();
                getWeatherVals();
                getPlaylistVals();
            })
            .fail(function () {
                mdui.snackbar({
                    message: '连接设备失败',
                    position: 'top'
                });
                mdui.alert("设备在规定的时间内没有响应。请检查设备网络状态，然后重试。", "连接已断开", function () { connectDevice(); }, { confirmText: "重新连接", history: false, modal: true, closeOnEsc: false, closeOnConfirm: true });
            })
            .always(
                function () {
                    hideProgressBar();
                }
            );
    }

    // 调整底部导航栏颜色
    function bottomNavColor() {
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            $('#bottom-nav-div').removeClass('mdui-color-theme');
            $('#bottom-nav-div').addClass('mdui-color-grey-900');
        } else {
            $('#bottom-nav-div').removeClass('mdui-color-grey-900');
            $('#bottom-nav-div').addClass('mdui-color-theme');
        }
    }

    ////////////////////
    // 按钮回调函数
    ////////////////////

    // 设置 - 亮度滑块
    $("#brightness-slider").change(function () {
        getBrightness($("#brightness-slider").val());
        updateBrighenessIcon();
    });

    // 设置 - 自动亮度开关
    $("#brightness-auto-check").change(function () {
        getAutoBright($("#brightness-auto-check").is(":checked"));
        updateBrighenessIcon();
    });

    // 设置 - 自动旋转开关
    $("#rotation-auto-check").change(function () {
        getAutoRotate($("#rotation-auto-check").is(":checked"));
        updateEotationIcon();
    });

    // 设置 - 时区
    $("#device-timezone-select").change(function () {
        getTimezone($("#device-timezone-select").val());
    });

    // 设置 - 更新天气配置按钮
    $("#update-weather-conf-btn").click(function () {
        getWeatherLocation($("#device-weather-loc-name-input").val(), $("#device-weather-loc-lat-input").val(), $("#device-weather-loc-lon-input").val());
    });

    // 设置 - 更新米游社配置按钮
    $("#update-hoyolab-conf-btn").click(function () {
        postHoyolabConf($("#hoyolab-uid-input").val(), $("#hoyolab-cookie-input").val(), $("#hoyolab-guid-input").val());
    });

    // 底部导航栏 - 设置菜单
    $("#settings-a").click(function () {
        $(".mdui-container").prop("hidden", true);
        $("#settings-container").prop("hidden", false);
    });
    // 底部导航栏 - 播放列表
    $("#playlist-a").click(function () {
        $(".mdui-container").prop("hidden", true);
        $("#playlist-container").prop("hidden", false);
    });

    // 底部导航栏 - 背景色
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
        bottomNavColor();
    });

    // 侧栏 - 关于
    $("#utility-about-div").click(function () {
        mdui.alert("神之眼实用程序<br/>@mr258876 2022-2023<br/><br/>如果您喜欢本项目，请在Github上Star本项目！", "关于实用程序");
    });

    ////////////////////
    //  其他
    ////////////////////

    //获取url中的参数
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象
        var r = window.location.search.substr(1).match(reg);  //匹配目标参数
        if (r != null) return unescape(r[2]); return null; //返回参数值
    }

    $(document).ready(function () {
        // 设置设备IP地址
        device_IP = getUrlParam("ip");
        if (device_IP) {
            connectDevice();
        } else if ($(location).prop("host").match(IP_ADDRESS_EXP)) {
            device_IP = $(location).prop("host");
            connectDevice();
        } else {
            mdui.prompt("设备IP地址", "请指定设备IP地址", function (value) { $(location).prop("href", $(location).prop("href").replace("#mdui-dialog", "") + "?ip=" + value); }, function (value) { }, { confirmText: "确认", cancelText: "取消", modal: true, closeOnConfirm: false, confirmOnEnter: true, maxlength: 15 });
        }

        bottomNavColor();

        mdui.mutation();
    });
</script>

</html>